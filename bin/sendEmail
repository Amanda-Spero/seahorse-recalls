#!/usr/bin/env node

const mysql = require('mysql2/promise');

const sql = {
  database: process.env.database || 'project2db',
  host: process.env.host || 'localhost',
  username: process.env.username || 'root',
  password: process.env.password || process.env.MYSQL_PWD,
};

const getSearches = async () => {
  const query = `
  select u.id as UserId
  , u.firstName
  , u.email
  , ss.make
  , ss.model
  , ss.year
  , ss.notified
  from users u
  inner join savedSearches ss
  on ss.userid = u.id
  where ss.notified is null;
  `;

  const connection = await mysql.createConnection({
    host: sql.host,
    user: sql.username,
    database: sql.database,
    password: sql.password,
  });

  const [ rows, fields ] = await connection.execute(query);

  connection.close();
  return [rows, fields];

}

getSearches().then( results => {
  // for each result we need to:
  // 1) run the query against the api
  // if results found send email and mark record as notified
  //
});

console.log('Starting Send Mail Job');
